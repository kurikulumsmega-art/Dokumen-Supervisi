<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring Supervisi Pembelajaran - SMKN 1 Purbalingga</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Softer background color */
            background-image: linear-gradient(to bottom right, #f3f4f6, #e5e7eb);
        }
        .chart-container {
            position: relative;
            height: 60vh; /* Adjusted for better visibility */
            width: 100%;
        }
        .card {
            transition: all 0.3s ease-in-out;
            background-color: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e5e7eb;
        }
        ::-webkit-scrollbar-thumb {
            background: #a5b4fc;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #818cf8;
        }
        .table-header-sticky {
            position: sticky;
            top: 0;
            z-index: 10;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-10">
            <div class="inline-flex items-center justify-center">
                 <svg class="w-12 h-12 text-indigo-600 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Sistem Monitoring Administrasi Pembelajaran</h1>
            </div>
            <p class="text-lg text-gray-600 mt-2">SMK Negeri 1 Purbalingga</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Kolom Form Input -->
            <div class="lg:col-span-1 card bg-white p-6 rounded-2xl shadow-xl">
                <h2 class="text-2xl font-semibold mb-6 text-gray-700 border-b pb-3">Formulir Input Data</h2>
                <form id="submissionForm" class="space-y-4">
                    <div>
                        <label for="teacherName" class="block text-sm font-medium text-gray-700 mb-1">Nama Guru</label>
                        <select id="teacherName" name="teacherName" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-300">
                            <option value="">Pilih Nama Guru...</option>
                        </select>
                    </div>
                    <div>
                        <label for="teacherNip" class="block text-sm font-medium text-gray-700 mb-1">NIP</label>
                        <input type="text" id="teacherNip" name="teacherNip" readonly class="w-full p-3 bg-gray-100 border border-gray-300 rounded-lg cursor-not-allowed">
                    </div>
                    
                    <div id="documentLinks" class="space-y-3 pt-4">
                        <h3 class="text-md font-semibold text-gray-600">Link Dokumen Perangkat Ajar:</h3>
                        <!-- Input link akan di-generate oleh JavaScript -->
                    </div>

                    <div class="pt-4">
                        <button type="submit" id="submitButton" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold py-3 px-4 rounded-lg hover:from-indigo-700 hover:to-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-300 ease-in-out flex items-center justify-center shadow-lg hover:shadow-xl">
                            <span id="buttonText">Kirim Data</span>
                            <svg id="buttonSpinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </button>
                    </div>
                </form>
            </div>

            <!-- Kolom Dashboard & Grafik -->
            <div class="lg:col-span-2 card bg-white p-6 rounded-2xl shadow-xl">
                <h2 class="text-2xl font-semibold mb-6 text-gray-700 border-b pb-3">Dashboard Monitoring</h2>
                <p class="text-sm text-gray-500 mb-4">Grafik ini menunjukkan persentase kelengkapan dokumen yang telah dikirim oleh masing-masing guru.</p>
                <div class="chart-container">
                    <canvas id="submissionChart"></canvas>
                </div>
                 <div class="mt-8">
                    <h3 class="text-xl font-semibold mb-4 text-gray-700">Detail Status Pengumpulan</h3>
                    <div class="max-h-[300px] overflow-y-auto border border-gray-200 rounded-lg">
                         <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 table-header-sticky">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Guru</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelengkapan</th>
                                </tr>
                            </thead>
                            <tbody id="statusTable" class="bg-white divide-y divide-gray-200">
                                <!-- Data status akan di-generate oleh JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Notifikasi -->
        <div id="notification" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg transform translate-x-full transition-transform duration-500 z-50">
            <p id="notification-message"></p>
        </div>
    </div>

<script>
    // --- KONFIGURASI PENTING ---
    const SPREADSHEET_URL = 'https://script.google.com/macros/s/AKfycbxdb8Sb4ZjNzs9Y8BnhPCUQUhUANVd0aDPCmNdc708BOJI8UmAID7eqltE9jDP_pWJf/exec';

    // --- DATA GURU & DOKUMEN ---
    const teachersData = [
        { name: 'Dra. Sri Mularsih', nip: '196706201994122001' }, { name: 'Drs. Fiva Widiarto', nip: '196510231996011002' },
        { name: 'Wahyu Budi Susapti, S.Pd, MM.', nip: '197207291997022002' }, { name: 'Marwoto, S.Pd, S.Kom', nip: '196904082000121001' },
        { name: 'Sri Endah Swarastuti, S.Pd', nip: '197407022003122004' }, { name: 'Dra. Cukat Budi Rahayu', nip: '196901121994032010' },
        { name: 'Dra. Diah Ayu Supriyanti', nip: '196603261994122004' }, { name: 'Justina Trirahaju Leksanawati, S.Pd., M.Si.', nip: '197104162003122006' },
        { name: 'Sri Wahyuni, S.Pd', nip: '197008022002122004' }, { name: 'Dwi Agus Tri M.M., S.Pd', nip: '197102232002122004' },
        { name: 'Sumardi, S.Pd., S.Kom', nip: '197305272003121002' }, { name: 'Agung Pamuji, S.Pd', nip: '197402132005011008' },
        { name: 'Retnowati, S.Pd', nip: '197303272005012009' }, { name: 'Tony Eka Martin Wibowo, S.Si.', nip: '197912092005011004' },
        { name: 'Nur Romlah, S.Pd', nip: '197509082008012008' }, { name: 'Deddy Suwito, S.Kom', nip: '197209022006041013' },
        { name: 'Agus Wuryanto, S.Pd', nip: '197503222006041002' }, { name: 'Tri Puji Utami, S.Kom', nip: '198304252009032009' },
        { name: 'Puji Pertiwi Sayekti, S.Pd', nip: '196805102005012011' }, { name: 'Nur Fajriyahti, S.Pd.', nip: '197005212007012014' },
        { name: 'Srirahayu, S.Pd.', nip: '197408042008012009' }, { name: 'Romidin, S.Pd', nip: '197505052008011021' },
        { name: 'Teguh Cahyono, S.Pd.', nip: '198110232006041010' }, { name: 'Seto Eko Purwanto, S.Si', nip: '197804232010011009' },
        { name: 'Nelly Amaliyah, S.Psi', nip: '197907032010012019' }, { name: 'Satyo Nugroho, S.Kom.', nip: '197807142009031006' },
        { name: 'Suratno, S.Pd', nip: '198409032010011012' }, { name: 'Vektor Realita Aditopo, S.Pd', nip: '198603312011011003' },
        { name: 'Adi Setiawan, S.Pd.', nip: '199012292014021001' }, { name: 'Galih Tyas Anjari, S.Pd.', nip: '199201212014022001' },
        { name: 'Deti Lestiyorini, S.Pd.', nip: '198912142014022001' }, { name: 'Mahzun, S.Pd I', nip: '197601072008011009' },
        { name: 'Sugeng Pitoyo, S.Pd.', nip: '197311032008011002' }, { name: 'Asriyatun, S.Pd', nip: '199208262020122009' },
        { name: 'Nur Laeli, S.Pd', nip: '199704112020122011' }, { name: 'Sepudin Zupri, S.Kom', nip: '197010222022211001' },
        { name: 'Arif Nurokhman, S.Pd', nip: '198010172022211002' }, { name: 'Elis Sugiarti, S.Pd.', nip: '198503072022212028' },
        { name: 'Sudiyarti, S.Pd', nip: '198511182022212012' }, { name: 'Otiah, S.Pd.', nip: '198802242022212013' },
        { name: 'Novaristya Widyasmara Pamungkas, S.Pd', nip: '198811042022211004' }, { name: 'Menik Yuni Hartini, S.Pd.', nip: '198906292022212008' },
        { name: 'Baiq Nur Aisyah, S.Pd.', nip: '198909222022212005' }, { name: 'Sulistiono, S.Pd.', nip: '199112202022211007' },
        { name: 'Isria Rizqona Firdausyi, S.Pd.', nip: '199201312022212011' }, { name: 'Hindun Fatmawati, S.Pd.', nip: '199210042022212007' },
        { name: 'Ana Nurlatifah, S.Pd.', nip: '199304032022212014' }, { name: 'Dwi Inayah Rahmawati, M.Pd.', nip: '199311282022212011' },
        { name: 'Danu Dwi Jatmiko, S.Pd.', nip: '199401192022211003' }, { name: 'Restu Afri Widhi Hastutiningsih, S.Pd.', nip: '199604032022212009' },
        { name: 'Nining Setiani, S.Pd.', nip: '199610102022212008' }, { name: 'Kukuh Pribadi, S.Pd.', nip: '198610232022211006' },
        { name: 'Yekti Apriyoni, S.Pd.', nip: '197804272023212002' }, { name: 'Novita Adhimurti, S.Pd.', nip: '197811142023212001' },
        { name: 'Khamsyatun Yudiana, S.Pd.I.', nip: '198207132023212011' }, { name: 'Nanang Cahyana, S.Pd.Ing.', nip: '198603172023211003' },
        { name: 'Waskito Ismu Hastomo, S.Pd.', nip: '198606092023211007' }, { name: 'Lely Erawati, S.Pd.', nip: '198708212023212018' },
        { name: 'Septian Endro Laksono, S.Pd.', nip: '199009052023211004' }, { name: 'Firmanika Rozaqi, S.Pd.', nip: '199104242023212024' },
        { name: 'Devi Artati, S.Pd.', nip: '199210112023212020' }, { name: 'Soviatun Khasanah, S.Pd.', nip: '199606302023212006' },
        { name: 'Miftah Iskandar, S.Pd.', nip: '198512112023211006' }, { name: 'Dista Puspitasari Adi, S.Pd.', nip: '198603182024212004' },
        { name: 'Rita Wijiarti, S.Pd.', nip: '199410172024212021' }, { name: 'Safa Aulia Astri, S.Sos', nip: '199607212024212021' },
        { name: 'Agus Sutono, S.Pd.', nip: '197406182025211007' }, { name: 'Yanti Karadina, S.Pd.', nip: '197512172025212006' },
        { name: 'Widia Sukaesih, S.E.', nip: '197810082025212008' }, { name: 'Triyanto, S.Pd.', nip: '198411252025211021' },
        { name: 'Inayatul Munawaroh, S.Pd.', nip: '199301062025212023' }, { name: 'Danu Setio Aji, S.Pd.', nip: '199310162025211021' },
        { name: 'Hera Dwi Suryandari, S.Pd.', nip: '199312262025212012' }, { name: 'Slamet Suparman, S.Pd.', nip: '-' },
        { name: 'Devi Dwi Wahyuni, S.Pd.', nip: '-' }, { name: 'Muhammad Idris Afandi, S.S., M.Pd.', nip: '-' },
        { name: 'Rindhi Rezqi Hertindha, M.Pd.', nip: '-' }, { name: 'Seli Fadriyah, S.Pd.', nip: '-' },
        { name: 'Nurhidayah, S.S., M.Pd.', nip: '-' }, { name: 'Prana Prakasita, S.Pd.', nip: '-' },
        { name: 'Rita Puspitasari, S.Pd.', nip: '-' }, { name: 'Ullil Hykmah, S.Pd.', nip: '-' }
    ].sort((a, b) => a.name.localeCompare(b.name));

    const documents = [
        "Capaian Pembelajaran", "Alur Tujuan Pembelajaran", "Tujuan Pembelajaran",
        "Program Tahunan", "Program Semester", "Analisis Minggu Efektif",
        "KKTP", "Kaldik", "RPM/Modul Ajar", "Daftar Nilai, Soal dan Analisis"
    ];

    let submissionChart;
    let chartData = {};

    // --- FUNGSI-FUNGSI ---
    function generateColorPalette(numColors) {
        const colors = [];
        const hueStep = 360 / numColors;
        for (let i = 0; i < numColors; i++) {
            const hue = (210 + i * hueStep) % 360;
            colors.push(`hsla(${hue}, 75%, 60%, 0.85)`);
        }
        return colors;
    }

    function showNotification(message, isError = false) {
        const notification = document.getElementById('notification');
        const notificationMessage = document.getElementById('notification-message');
        notificationMessage.textContent = message;
        notification.classList.remove('bg-green-500', 'bg-red-500');
        notification.classList.add(isError ? 'bg-red-500' : 'bg-green-500');
        notification.classList.remove('translate-x-full');
        setTimeout(() => {
            notification.classList.add('translate-x-full');
        }, 3000);
    }

    function updateDashboard() {
        const sortedTeachers = Object.keys(chartData).sort((a, b) => a.localeCompare(b));
        
        const labels = sortedTeachers;
        const data = sortedTeachers.map(name => chartData[name].percentage);
        const colors = sortedTeachers.map(name => chartData[name].color);
        
        submissionChart.data.labels = labels;
        submissionChart.data.datasets[0].data = data;
        submissionChart.data.datasets[0].backgroundColor = colors;
        submissionChart.data.datasets[0].borderColor = colors.map(c => c.replace('0.85', '1'));
        submissionChart.update();

        const tableBody = document.getElementById('statusTable');
        tableBody.innerHTML = '';
        labels.forEach((name, index) => {
            const teacherProgress = chartData[name];
            const percentage = teacherProgress.percentage.toFixed(0);
            const statusClass = percentage == 100 ? 'bg-teal-100 text-teal-800' : 'bg-amber-100 text-amber-800';
            const statusText = percentage == 100 ? 'Lengkap' : 'Belum Lengkap';
            const rowClass = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';

            const row = `
                <tr class="${rowClass}">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                            ${statusText}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <div class="flex items-center">
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div class="h-2.5 rounded-full" style="width: ${percentage}%; background-color: ${teacherProgress.color};"></div>
                            </div>
                            <span class="ml-3 font-medium text-gray-700">${percentage}%</span>
                        </div>
                    </td>
                </tr>
            `;
            tableBody.innerHTML += row;
        });
    }

    async function fetchInitialData() {
        const palette = generateColorPalette(teachersData.length);
        
        // Initialize chartData with all teachers first
        teachersData.forEach((teacher, index) => {
            chartData[teacher.name] = { 
                submitted: 0, 
                total: documents.length, 
                percentage: 0, 
                color: palette[index] 
            };
        });

        if (SPREADSHEET_URL === 'https://script.google.com/macros/s/AKfycbxdb8Sb4ZjNzs9Y8BnhPCUQUhUANVd0aDPCmNdc708BOJI8UmAID7eqltE9jDP_pWJf/exec') {
             console.warn("URL Google Apps Script belum diatur. Menampilkan data dummy.");
             updateDashboard();
             return;
        }

        try {
            const response = await fetch(SPREADSHEET_URL + '?action=read');
            if (!response.ok) throw new Error('Gagal mengambil data dari spreadsheet.');
            
            const data = await response.json();
            
            if (Array.isArray(data)) {
                data.forEach(row => {
                    const teacherName = row['Nama Guru'];
                    if (chartData[teacherName]) {
                        let submittedCount = 0;
                        documents.forEach(docName => {
                            if (row[docName] && String(row[docName]).trim() !== '') {
                                submittedCount++;
                            }
                        });
                        chartData[teacherName].submitted = submittedCount;
                        chartData[teacherName].percentage = (submittedCount / documents.length) * 100;
                    }
                });
            } else {
                // Handle cases where data is not an array, e.g., an error object from the script
                console.warn("Menerima data yang bukan array:", data);
                if (data && data.message) {
                    // Log a warning instead of throwing an error to prevent red console errors on empty sheets.
                    console.warn("Pesan dari Google Script (kemungkinan sheet kosong):", data.message);
                }
            }
            
            updateDashboard();

        } catch (error) {
            console.error('Error fetching initial data:', error);
            showNotification('Gagal memuat data awal dari Spreadsheet.', true);
            updateDashboard(); // Show empty dashboard on error
        }
    }


    document.addEventListener('DOMContentLoaded', () => {
        const teacherSelect = document.getElementById('teacherName');
        const nipInput = document.getElementById('teacherNip');
        const linksContainer = document.getElementById('documentLinks');
        const form = document.getElementById('submissionForm');
        const submitButton = document.getElementById('submitButton');
        const buttonText = document.getElementById('buttonText');
        const buttonSpinner = document.getElementById('buttonSpinner');

        teachersData.forEach(teacher => {
            const option = document.createElement('option');
            option.value = teacher.name;
            option.textContent = teacher.name;
            teacherSelect.appendChild(option);
        });

        documents.forEach(doc => {
            const div = document.createElement('div');
            const label = document.createElement('label');
            label.htmlFor = `link_${doc.replace(/[\s/]/g, '')}`;
            label.textContent = doc;
            label.className = 'block text-sm font-medium text-gray-600';

            const input = document.createElement('input');
            input.type = 'url';
            input.id = `link_${doc.replace(/[\s/]/g, '')}`;
            input.name = doc;
            input.placeholder = 'https://...';
            input.className = 'mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition';
            
            div.appendChild(label);
            div.appendChild(input);
            linksContainer.appendChild(div);
        });

        teacherSelect.addEventListener('change', () => {
            const selectedTeacher = teachersData.find(t => t.name === teacherSelect.value);
            nipInput.value = selectedTeacher ? selectedTeacher.nip : '';
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (SPREADSHEET_URL === 'https://script.google.com/macros/s/AKfycbxdb8Sb4ZjNzs9Y8BnhPCUQUhUANVd0aDPCmNdc708BOJI8UmAID7eqltE9jDP_pWJf/exec') {
                showNotification('Harap konfigurasi URL Google Apps Script terlebih dahulu.', true);
                return;
            }

            const teacherName = teacherSelect.value;
            if (!teacherName) {
                showNotification('Silakan pilih nama guru terlebih dahulu.', true);
                return;
            }
            
            buttonText.textContent = 'Mengirim...';
            buttonSpinner.classList.remove('hidden');
            submitButton.disabled = true;

            const formData = new FormData(form);
            const data = {
                teacherName: formData.get('teacherName'),
                nip: formData.get('teacherNip'),
                links: {}
            };
            
            let submittedCount = 0;
            documents.forEach(doc => {
                const linkValue = formData.get(doc);
                data.links[doc] = linkValue;
                if(linkValue && linkValue.trim() !== '') {
                    submittedCount++;
                }
            });

            try {
                const response = await fetch(SPREADSHEET_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!response.ok) throw new Error('Terjadi kesalahan saat mengirim data.');
                
                const result = await response.json();
                if (result.result === 'success') {
                    showNotification('Data berhasil disimpan!');
                    form.reset();
                    nipInput.value = '';
                    
                    chartData[data.teacherName].submitted = submittedCount;
                    chartData[data.teacherName].percentage = (submittedCount / documents.length) * 100;
                    updateDashboard();

                } else {
                    throw new Error(result.message || 'Gagal menyimpan data.');
                }
            } catch (error) {
                console.error('Submission Error:', error);
                showNotification(error.message, true);
            } finally {
                buttonText.textContent = 'Kirim Data';
                buttonSpinner.classList.add('hidden');
                submitButton.disabled = false;
            }
        });

        const ctx = document.getElementById('submissionChart').getContext('2d');
        submissionChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: '% Kelengkapan Dokumen',
                    data: [],
                    backgroundColor: [],
                    borderColor: [],
                    borderWidth: 1.5,
                    borderRadius: 8,
                    borderSkipped: false,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        grid: { color: '#e5e7eb' },
                        ticks: {
                            color: '#4b5563',
                            font: { weight: '500' },
                            callback: function(value) { return value + "%" }
                        }
                    },
                    x: {
                         grid: { display: false },
                         ticks: {
                            color: '#4b5563',
                            font: { weight: '500' },
                            maxRotation: 70,
                            minRotation: 70,
                            autoSkip: false,
                         }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                         backgroundColor: '#111827',
                         titleFont: { size: 14, weight: 'bold' },
                         bodyFont: { size: 12 },
                         padding: 12,
                         cornerRadius: 8,
                         displayColors: false,
                         callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) { label += ': '; }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y.toFixed(0) + '%';
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });

        fetchInitialData();
    });
</script>
</body>
</html>

